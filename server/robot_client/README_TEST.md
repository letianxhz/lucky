# 机器人测试说明

本文档说明如何使用机器人测试修改后的 lucky 服务器代码。

## 修改内容

本次修改主要优化了消息处理器的注册机制：

1. **消息处理器注册优化**
   - 每个模块（item、login）在 `handler.go` 文件中通过 `init()` 函数自动注册消息处理器
   - 移除了 `actorPlayer.OnInit()` 中的反射遍历逻辑
   - 简化了代码结构，提高了可维护性

2. **客户端回调处理优化**
   - 优化了客户端超时后的回调处理
   - 将 "callback not found" 警告降级为 DEBUG 级别
   - 改进了竞态条件处理

## 测试步骤

### 1. 启动服务

确保以下服务已启动：

```bash
# 1. Web 服务 (端口 8081)
cd lucky/server
./bin/web

# 2. Gate 服务 (端口 10011)
./bin/gate

# 3. Game 服务 (节点 10001)
NODE_ID=10001 ./bin/game
```

或者使用启动脚本（如果有）：

```bash
cd lucky/server
./start_all.sh
```

### 2. 运行测试

#### 方法 1: 使用编译好的测试程序

```bash
cd lucky/server
./bin/robot_test
```

#### 方法 2: 直接运行源码

```bash
cd lucky/server
go run ./robot_client
```

### 3. 测试内容

测试程序会执行以下操作：

1. **登录流程**
   - 获取登录 token
   - 连接网关服务器
   - 用户登录
   - 查看/创建角色
   - 角色进入游戏

2. **购买道具测试 - 成功案例**
   - 购买道具 1001 (金币支付) x1
   - 购买道具 1001 (金币支付) x2
   - 购买道具 1002 (钻石支付) x1

3. **购买道具测试 - 失败案例**
   - 无效道具ID (应该返回错误码)
   - 无效数量 (应该返回错误码)
   - 无效支付类型 (应该返回错误码)

## 验证修改后的功能

### 验证消息处理器注册

测试过程中，观察日志中是否有以下信息：

1. **模块初始化日志**
   ```
   [ItemModule] Registered handler: buyItem
   [LoginModule] Registered handlers: select, create, enter
   ```

2. **消息处理器注册日志**
   ```
   [Handler] Registered X message handler(s) to actor
   ```

### 验证消息处理

测试过程中，验证以下消息是否正常处理：

1. **登录相关消息**
   - `game.player.select` - 查询角色列表
   - `game.player.create` - 创建角色
   - `game.player.enter` - 进入游戏

2. **道具相关消息**
   - `game.player.buyItem` - 购买道具

### 验证客户端回调处理

观察日志中是否还有 "callback not found" 的 WARN 级别日志：

- ✅ **正常情况**: 不应该有 WARN 级别的 "callback not found" 日志
- ✅ **DEBUG 级别**: 如果有超时情况，应该只看到 DEBUG 级别的日志

## 预期结果

### 成功案例

每个成功案例应该返回：
- `itemId`: 购买的道具ID
- `count`: 购买数量
- `payType`: 支付类型
- `costAmount`: 消耗金额

### 失败案例

每个失败案例应该返回相应的错误码：
- 无效道具ID: 返回 `ShopItemNotFound` (401)
- 无效参数: 返回 `ShopItemInvalidParam` (403)

## 注意事项

1. **服务依赖**: 确保所有服务（Web、Gate、Game）都已启动
2. **端口占用**: 确保端口 8081、10011 未被占用
3. **测试账号**: 测试程序会自动注册账号 `test_buy_item`（如果不存在）
4. **日志级别**: 测试程序默认开启详细日志（`printLog = true`）

## 故障排查

### 问题 1: 连接失败

**症状**: `连接网关失败` 或 `连接超时`

**解决方案**:
- 检查 Gate 服务是否启动
- 检查端口 10011 是否被占用
- 检查防火墙设置

### 问题 2: 登录失败

**症状**: `用户登录失败` 或 `获取 token 失败`

**解决方案**:
- 检查 Web 服务是否启动（端口 8081）
- 检查 Game 服务是否启动（节点 10001）
- 检查服务配置是否正确

### 问题 3: 消息处理失败

**症状**: 消息发送后没有响应或返回错误

**解决方案**:
- 检查 Game 服务日志，查看消息处理器是否已注册
- 检查 `handler.go` 文件是否正确实现
- 检查 DI 容器是否正确初始化

## 测试完成

测试完成后，程序会：
1. 保持连接 5 秒
2. 自动断开连接
3. 输出测试总结

如果所有测试用例都通过，说明修改后的代码工作正常。



