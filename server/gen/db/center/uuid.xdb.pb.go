// Code generated by protoc-gen-xdb. DO NOT EDIT.
// versions:
//	protoc-gen-xdb v1.0.0

package center

import (
	"context"
	"encoding/json"
	"fmt"
	proto "google.golang.org/protobuf/proto"
	"lucky/server/pkg/xdb"
	"reflect"
)

// Field constants for Uuid
const (
	UuidFieldName xdb.Field = iota
	UuidFieldValue
	UuidFieldCtime
	UuidFieldMtime
)

// UuidPK 主键
type UuidPK struct {
	Name string
}

func (pk *UuidPK) Source() *xdb.Source {
	return _UuidSource
}

func (pk *UuidPK) String() string {
	return fmt.Sprintf("uuid:%v", pk.Name)
}

func (pk *UuidPK) HashGroup() int {
	return int(pk.Name % 16)
}

func (pk *UuidPK) Empty() bool {
	return pk.Name == 0
}

func (pk *UuidPK) PrefixOf(key xdb.Key) bool {
	_, ok := key.(*UuidPK)
	if !ok {
		return false
	}
	// TODO: 实现前缀匹配逻辑
	return false
}

func (pk *UuidPK) Full() bool {
	return pk.Name != 0
}

func (pk *UuidPK) FetchFilter() interface{} {
	filter := make(map[string]interface{})
	if pk.Name != 0 {
		filter["name"] = pk.Name
	}
	return filter
}

// UuidRecord 记录结构体
type UuidRecord struct {
	xdb.Header
	Uuid
}

func (r *UuidRecord) Source() *xdb.Source {
	return _UuidSource
}

func (r *UuidRecord) XId() string {
	return fmt.Sprintf("uuid:%v", r.Name)
}

func (r *UuidRecord) Lifecycle() xdb.Lifecycle {
	return r.Header.Lifecycle()
}

func (r *UuidRecord) Snapshoot() interface{} {
	return &r.Uuid
}

func (r *UuidRecord) XVersion() int64 {
	return 0
}

func (r *UuidRecord) GetHeader() *xdb.Header {
	return &r.Header
}

func (r *UuidRecord) MarshalJSON() ([]byte, error) {
	return json.Marshal(&r.Uuid)
}

func (r *UuidRecord) UnmarshalJSON(data []byte) error {
	return json.Unmarshal(data, &r.Uuid)
}

func (r *UuidRecord) String() string {
	return fmt.Sprintf("UuidRecord{%s:%v}", "name", r.Name)
}

func (r *UuidRecord) Init(ctx context.Context, data interface{}) error {
	proto, ok := data.(*Uuid)
	if !ok {
		return fmt.Errorf("invalid data type")
	}
	r.Uuid = *proto
	r.Header.Init(xdb.LifecycleNew)
	return nil
}

func (r *UuidRecord) Update(ctx context.Context, changes interface{}, fs xdb.FieldSet) error {
	proto, ok := changes.(*Uuid)
	if !ok {
		return fmt.Errorf("invalid changes type")
	}
	if fs.Contains(UuidFieldName) {
		r.Name = proto.Name
	}
	if fs.Contains(UuidFieldValue) {
		r.Value = proto.Value
	}
	if fs.Contains(UuidFieldCtime) {
		r.Ctime = proto.Ctime
	}
	if fs.Contains(UuidFieldMtime) {
		r.Mtime = proto.Mtime
	}
	return nil
}

func (r *UuidRecord) Delete(ctx context.Context) bool {
	return r.Header.MarkAsDeleted(ctx)
}

func (r *UuidRecord) Commit(ctx context.Context) (xdb.Commitment, xdb.FieldSet) {
	commitment := &UuidCommitment{
		data:      &r.Uuid,
		changes:   r.Header.Changes(),
		lifecycle: r.Header.Lifecycle(),
	}
	return commitment, r.Header.Changes()
}

func (r *UuidRecord) Committing() bool {
	return r.Header.Committing()
}

func (r *UuidRecord) Dirty() bool {
	return r.Header.Dirty()
}

func (r *UuidRecord) SavingIndex() int32 {
	return r.Header.SavingIndex
}

func (r *UuidRecord) SetSavingIndex(idx int32) {
	r.Header.SavingIndex = idx
}

var _UuidSource = &xdb.Source{
	ProtoType:  reflect.TypeOf((*Uuid)(nil)).Elem(),
	RecordType: reflect.TypeOf((*UuidRecord)(nil)).Elem(),
	PKType:     reflect.TypeOf((*UuidPK)(nil)).Elem(),
	Namespace:  "uuid",
	DriverName: "none",
	TableName:  "uuid",
	KeySize:    1,

	PKCreator: func(args []interface{}) (xdb.PK, error) {
		if len(args) < 1 {
			return nil, fmt.Errorf("invalid args count")
		}
		return &UuidPK{
			Name: args[0].(string),
		}, nil
	},

	PKOf: func(obj interface{}) xdb.PK {
		// 支持 Record 类型
		if r, ok := obj.(*UuidRecord); ok {
			return &UuidPK{
				Name: r.Name,
			}
		}
		// 支持 proto 类型
		if p, ok := obj.(*Uuid); ok {
			return &UuidPK{
				Name: p.Name,
			}
		}
		// 支持 Commitment 类型
		if c, ok := obj.(*UuidCommitment); ok {
			return &UuidPK{
				Name: c.data.Name,
			}
		}
		return nil
	},

	PKComparator: func(a, b interface{}) int {
		pk1 := a.(*UuidPK)
		pk2 := b.(*UuidPK)
		if pk1.Name < pk2.Name {
			return -1
		} else if pk1.Name > pk2.Name {
			return 1
		}
		return 0
	},

	CreateCommitment: func() xdb.Commitment {
		return &UuidCommitment{}
	},
}

// UuidCommitment 提交对象
type UuidCommitment struct {
	data      *Uuid
	changes   xdb.FieldSet
	lifecycle xdb.Lifecycle
}

func (c *UuidCommitment) Source() *xdb.Source {
	return _UuidSource
}

func (c *UuidCommitment) Merge(other xdb.Commitment) bool {
	otherC, ok := other.(*UuidCommitment)
	if !ok {
		return false
	}
	c.changes = c.changes.Union(otherC.changes)
	return true
}

func (c *UuidCommitment) Changes() xdb.FieldSet {
	return c.changes
}

func (c *UuidCommitment) PrepareWrite() (interface{}, interface{}) {
	return c.data, nil
}

func (c *UuidCommitment) Lifecycle() xdb.Lifecycle {
	return c.lifecycle
}

func (c *UuidCommitment) Marshal() ([]byte, error) {
	return proto.Marshal(c.data)
}

func (c *UuidCommitment) Unmarshal(data []byte) error {
	c.data = &Uuid{}
	return proto.Unmarshal(data, c.data)
}

func init() {
	_UuidSource.PKOf = func(obj interface{}) xdb.PK {
		r := obj.(*UuidRecord)
		return &UuidPK{
			Name: r.Name,
		}
	}
	xdb.RegisterSource(_UuidSource)
}
